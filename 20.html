<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U8 视频库</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #121212; color: white; text-align: center; }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px; }
        .video-item { cursor: pointer; background: #222; padding: 10px; border-radius: 10px; }
        .video-item img { width: 100%; border-radius: 10px; height: 120px; object-fit: cover; }
        .player-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); align-items: center; justify-content: center; }
        .player-container video { width: 80%; max-height: 80%; }
        .close-btn { position: absolute; top: 20px; right: 30px; font-size: 30px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>M3U8 视频库</h1>
    <div class="video-grid" id="videoList"></div>
    
    <div class="player-container" id="playerContainer">
        <span class="close-btn" onclick="closePlayer()">&times;</span>
        <video id="videoPlayer" controls></video>
    </div>
    
    <script>
        const videoListEl = document.getElementById("videoList");
        const playerContainer = document.getElementById("playerContainer");
        const videoPlayer = document.getElementById("videoPlayer");
        let videoData = [];
        let loadedCount = 0;
        const batchSize = 20;
        
        function fetchVideos(file) {
            fetch(file)
                .then(response => response.text())
                .then(text => {
                    videoData = text.split("\n").map(line => {
                        const parts = line.split(",");
                        return { title: parts[0], url: parts[1] };
                    }).filter(v => v.title && v.url);
                    loadMoreVideos();
                });
        }
        
        function generateThumbnail(videoUrl, callback) {
            const video = document.createElement("video");
            video.crossOrigin = "anonymous";
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(videoUrl);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    video.currentTime = 5; // 取第5秒的画面
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = videoUrl;
                video.currentTime = 5;
            }
            video.onloadeddata = () => {
                const canvas = document.createElement("canvas");
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                callback(canvas.toDataURL("image/png"));
            };
        }
        
        function loadMoreVideos() {
            const batch = videoData.slice(loadedCount, loadedCount + batchSize);
            batch.forEach(video => {
                const videoEl = document.createElement("div");
                videoEl.className = "video-item";
                
                const img = document.createElement("img");
                img.src = "https://via.placeholder.com/200?text=Loading...";
                img.alt = video.title;
                generateThumbnail(video.url, (thumbnail) => {
                    img.src = thumbnail;
                });
                
                const title = document.createElement("p");
                title.textContent = video.title;
                
                videoEl.appendChild(img);
                videoEl.appendChild(title);
                videoEl.onclick = () => openPlayer(video.url);
                videoListEl.appendChild(videoEl);
            });
            loadedCount += batchSize;
        }
        
        function openPlayer(url) {
            videoPlayer.src = url;
            playerContainer.style.display = "flex";
            videoPlayer.play();
        }
        
        function closePlayer() {
            videoPlayer.pause();
            playerContainer.style.display = "none";
        }
        
        window.addEventListener("scroll", () => {
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
                loadMoreVideos();
            }
        });
        
        fetchVideos("https://etxt.chickenkiller.com/s.txt");  // 读取本地文件
        // fetchVideos("https://www.google.com/s.txt");  // 读取网络文件
    </script>
</body>
</html>
